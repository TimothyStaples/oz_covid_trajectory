<!doctype html>
<html>
<head>
    <script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<style>

/*Create some styles for our svg objects*/
svg rect{fill: white;}
svg text{fill:black;
         font: 12px sans-serif;
         opacity: 1;}

         p{fill:black;
                  font: 12px sans-serif;
                  opacity: 1;}

div.tooltip {
    position: absolute;
    text-align: left;
    width: 150px;
    height: 43px;
    padding: 4px;
    color: white;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0px;
    border-radius: 8px;
    pointer-events: none;
}

</style>
<body>

<!---->
<div>
<p style="font-size:24px"><font: sans-serif><b>Australian State COVID-19 trends</b></p>
<p style="font-size:16px"><font: sans-serif>Hover over points to see estimated trajectory informed by the past seven days, projected out one week into the future. States are only shown if they have recorded 10 confirmed cases, and trajectories are only modelled once
there are seven days of post-10 case data.<br></p>
<div class = "chart"></div>
<p><font: 12px sans-serif>Data sourced from <a href="https://github.com/CSSEGISandData/COVID-19">John Hopkins University CCSE</a>. Trajectory models are generated in R. All code is under an <a href="https://mit-license.org/">MIT License</a>.
<br>
<b>To do list:</b><br>
Add example countries for comparison (e.g., Italy, Singapore, USA, UK)<br>
Create second plot with trajectories over time
</p>

<script>

var width = 650;
var height = 600;
var margin = {bottom:37.5, left: 50, top:5, right:30};
var yticks = [1,10,100,1000,10000];

var stateCols = {ACT: "#4d43c6", NSW: "#cb2030",
                 NT: "#5b0016", QLD: "#550f6f",
                 SA: "#e51e01", TAS: "#233b25",
                 VIC: "#d34994", WA: "#4b9532"}

var labeloffset = {x: width*0.01, y: height*0.01};

var horizlines = [1,10,20,30,40,50,60,70,80,90,100,
                  200,300,400,500,600,700,800,900,1000,
                  1100,1200,1300,1400,1500,1600,1700,1800,1900,
                  2000,3000,4000,5000];

// Set up log y d3.axis()
var yaxisScale = d3.scaleLog()
                  .domain([2000,10])
                  .range([0,height - margin.top - margin.bottom]);

// X-axis scale is linear
var xaxisScale = d3.scaleLinear()
                  .domain([0,25])
                  .range([0,width - margin.right - margin.left]);

var xaxisoffset = function(d){return xaxisScale(d) + margin.left;};
var yaxisoffset = function(d){return yaxisScale(d) + margin.top;};

// Set up plot svg space
var svgContainer = d3.selectAll(".chart")
                      .append("svg")
                      .attr("width", width)
                      .attr("height", height);

// Create axes
var yAxis = d3.axisLeft().scale(yaxisScale).ticks(100, ",.1s");
var xAxis = d3.axisBottom().scale(xaxisScale);

var yAxisGroup = svgContainer.append("g")
                  .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                    .call(yAxis);
var xAxisGroup = svgContainer.append("g")
                  .attr("transform", "translate(" + margin.left + "," + (height - margin.bottom) + ")")
                  .call(xAxis);

horizlines.forEach(function(d){
svgContainer.append("line")
            .attr("x1", margin.left)
            .attr("x2", width-margin.right)
            .attr("y1", yaxisoffset(d))
            .attr("y2", yaxisoffset(d))
            .attr("stroke", "#DCDCDC")
            .attr("stroke-width", 0.75);
          });

// Axis text labels
svgContainer.append("text")
            .attr("x", width/2)
            .attr("y", height - margin.bottom + 35)
            .style("text-anchor", "middle")
            .text("Days since 10 confirmed cases");

svgContainer.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", margin.left - 40)
            .attr("x", -(height/2))
            .style("text-anchor", "middle")
            .text("Number of confirmed COVID-19 cases");

//Create line & node text for later use
svgContainer.append("line")
            .attr("class", "trend")
            .attr("x1", -50)
            .attr("x2", -60)
            .attr("y1", -50)
            .attr("y2", -60)
            .style("stroke", "black")
            .style("stroke-width", 2)
            .style("stroke-dasharray", ("3,3"));

//Tooltip div
var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

// PLOT DATA

var lineFunction = d3.line()
.x(function(d) { return xaxisoffset(d.statetime);})
.y(function(d) { return yaxisoffset(d.count); })

var ozData = d3.csv("oz_model.csv", function(data){
  data.forEach(function(d){ d['statetime'] = +d['statetime']; });
  data.forEach(function(d){ d['count'] = +d['count']; });
  data.forEach(function(d){ d['int'] = +d['int']; });
  data.forEach(function(d){ d['slope'] = +d['slope']; });

  var dataGroup = d3.nest()
                    .key(function(d){return d["state"];})
                    .entries(data);

dataGroup.forEach(function(dataSub, i){

stateName = dataSub.key;
stateVals = dataSub.values;

      svgContainer.append("path")
          .attr("d", lineFunction(stateVals))
          .attr("stroke", stateCols[stateName])
          .attr("stroke-width", 2)
          .attr("fill", "none")
          .style("opacity", 0.4);

stateVals.forEach(function(pointSub, i){

if(pointSub.statetime >=7){
      svgContainer.append("circle") // Uses the enter().append() method
                    //.attr("class", "dot") // Assign a class for styling
                    .attr("cx", xaxisoffset(pointSub.statetime))
                    .attr("cy", yaxisoffset(pointSub.count))
                    .attr("r", 4)
                    .style("fill", stateCols[stateName])
                    .style("opacity", 1)
                    .style("stroke", "transparent")
                    .style("width",0)
                    .on("mouseover", function(d,i){

                      //Increase point size
                      d3.select(this).transition()
                      .duration("200")
                      .attr("r",7)

                      //Add trend line
                      d3.select(".trend")
                      .attr("x1", xaxisoffset(pointSub.statetime - 7))
                      .attr("x2", xaxisoffset(pointSub.statetime + 7))
                      .attr("y1", yaxisoffset(pointSub.min))
                      .attr("y2", yaxisoffset(pointSub.max))
                      .style("stroke", stateCols[pointSub.state])
                      .transition()
                      .duration("100")
                      .style("opacity", 1);

                      //Tooltip
                      div.html(pointSub.state + ": " + pointSub.date + " : " + pointSub.count + "<br>" +
                               "+" + " " + d3.format(".1%")(pointSub.incr) + " each day<br>" +
                               "Doubling every " + d3.format(".2")(pointSub.double) + " days")
                        .style("left", (d3.event.pageX) + 15 + "px")
                        .style("top", (d3.event.pageY - 28) + "px")
                        .style("background", stateCols[pointSub.state])
                        div.transition().duration(400)
                            .style("opacity", 0.8);

                    })
                    .on("mouseout", function(d,i){
                      d3.select(this).transition()
                      .duration("500")
                      .attr("r",4)

                      div.transition()
                         .duration(200)
                          .style("opacity", 0);

                      d3.select(".trend")
                      .transition()
                      .duration("200")
                      .style("opacity", 0);
                    });

                }
});

var lineText = svgContainer.append("text")
    .attr("x", xaxisoffset(d3.max(stateVals,
                  function(d) { return d.statetime; }))+labeloffset.x)
    .attr("y", yaxisoffset(d3.max(stateVals,
                  function(d) { return d.count; })) + labeloffset.y)
    .text(stateName)
    .style("fill", stateCols[stateName]);

    });

});

svgContainer.append("rect")
            .attr("x", margin.left)
            .attr("y", margin.top)
            .attr("width", width - margin.left - margin.right)
            .attr("height", height - margin.top - margin.bottom)
            .style("stroke", "black")
            .style("stroke-width", 2)
            .style("fill","transparent");

///////////////////////


    </script>
</body>
</html>
